<div class="comic-details-container">
    <!-- Header -->
    <header class="details-header glass-effect">
        <button class="back-btn" (click)="goBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                class="back-icon">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke-width="2"
                    stroke-linecap="round" />
            </svg>
            Back
        </button>
        <div class="header-content">
            <h1 class="comic-title">{{ comic?.title }}</h1>
            @if (comic?.metadata?.series) {
            <span class="comic-series">{{ comic?.metadata?.series }}</span>
            }
        </div>
        <div class="header-actions">
            <button class="action-btn primary" (click)="openReader()"
                [disabled]="!comic">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M5 12h14M12 5l7 7-7 7" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
                <span>Read Now</span>
            </button>
        </div>
    </header>

    <div class="details-content">
        <!-- Left Column: Cover & Quick Actions -->
        <div class="left-column">
            <!-- Cover Section -->
            <div class="cover-section">
                <div class="cover-card">
                    @if (coverUrl) {
                    <img [src]="coverUrl" alt="Cover" class="comic-cover-image"
                        (error)="onCoverError()">
                    } @else {
                    <div class="cover-placeholder"
                        [class]="coverPlaceholderClass">
                        <span class="cover-initials">{{ coverInitials }}</span>
                    </div>
                    }
                    <!-- Cover overlay with shadow -->
                    <div class="cover-overlay"></div>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="stat-item">
                        <span class="stat-label">Pages</span>
                        <span class="stat-value">{{ comic?.totalPages || 0
                            }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Size</span>
                        <span class="stat-value">{{ comic?.fileSize! | fileSize
                            }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Status</span>
                        <span class="stat-value">
                            @if (comic?.isRead) {
                            <span class="status-badge read">Read</span>
                            } @else if ((comic?.currentPage || 0) > 0) {
                            <span class="status-badge progress">In
                                Progress</span>
                            } @else {
                            <span class="status-badge unread">Unread</span>
                            }
                        </span>
                    </div>
                </div>

                <!-- Progress Bar -->
                @if (comic?.totalPages && comic?.totalPages! > 0) {
                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill"
                            [style.width.%]="progressPercent"></div>
                    </div>
                    <div class="progress-label">
                        <span>{{ comic?.currentPage || 0 }} / {{
                            comic?.totalPages }}</span>
                        <span class="percent">{{ progressPercent |
                            number:'1.0-0' }}%</span>
                    </div>
                </div>
                }
            </div>

            <!-- Reading Mode Selector -->
            <div class="section-card">
                <h3 class="card-title">Reading Mode</h3>
                <div class="reading-modes">
                    @for (mode of readingModes; track mode.id) {
                    <button class="mode-btn"
                        [class.active]="selectedReadingMode === mode.id"
                        [class.immersive]="mode.id === 'immersive'"
                        (click)="selectReadingMode(mode.id)"
                        [title]="mode.description">
                        <svg class="mode-icon" [innerHTML]="mode.iconSafe"></svg>
                        <span class="mode-name">{{ mode.name }}</span>
                    </button>
                    }
                </div>
            </div>

            <!-- Background Music -->
            <div class="section-card">
                <div class="card-header">
                    <h3 class="card-title">Background Music</h3>
                    <button class="music-toggle" (click)="toggleMusic()"
                        [class.active]="musicEnabled">
                        @if (musicEnabled) {
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M9 9v6a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V9a3 3 0 0 0-3-3h-6a3 3 0 0 0-3 3z"></path>
                            <path
                                d="M9 9H7a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path>
                        </svg>
                        } @else {
                        <svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor">
                            <path
                                d="M9 9v6a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V9a3 3 0 0 0-3-3h-6a3 3 0 0 0-3 3z"
                                stroke-width="2"></path>
                            <path d="M9 9H7a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"
                                stroke-width="2"></path>
                        </svg>
                        }
                    </button>
                </div>

                @if (musicEnabled) {
                <div class="music-container">
                    <div class="music-genres">
                        @for (genre of musicGenres; track genre.id) {
                        <button class="genre-btn"
                            [class.active]="selectedGenre === genre.id"
                            (click)="selectGenre(genre.id)">
                            <span class="genre-emoji">{{ genre.emoji }}</span>
                            <span>{{ genre.name }}</span>
                        </button>
                        }
                    </div>

                    <!-- Music Player -->
                    <div class="music-player">
                        <div class="player-controls">
                            <button class="player-btn" (click)="previousTrack()"
                                title="Previous">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 6v12M17 12L7 18V6l10 6z" />
                                </svg>
                            </button>
                            <button class="player-btn play"
                                (click)="togglePlayback()"
                                [class.playing]="isPlaying">
                                @if (isPlaying) {
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 4h4v16H6zm8 0h4v16h-4z" />
                                </svg>
                                } @else {
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                                }
                            </button>
                            <button class="player-btn" (click)="nextTrack()"
                                title="Next">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 18l10-6L6 6v12zM18 6v12" />
                                </svg>
                            </button>
                        </div>

                        <div class="volume-control">
                            <svg viewBox="0 0 24 24" fill="currentColor"
                                class="volume-icon">
                                <path d="M11 5L6 9H2v6h4l5 4V5z" />
                            </svg>
                            <input type="range" [(ngModel)]="volume" min="0"
                                max="100"
                                class="volume-slider" (input)="updateVolume()">
                            <span class="volume-label">{{ volume }}%</span>
                        </div>

                        @if (currentTrack) {
                        <div class="current-track">
                            <span class="track-title">{{ currentTrack.title
                                }}</span>
                            <span class="track-artist">{{ currentTrack.artist
                                }}</span>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>

        <!-- Right Column: Metadata & Details -->
        <div class="right-column">
            <!-- File Information -->
            <div class="section-card">
                <h3 class="card-title">File Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">File Name</span>
                        <span class="info-value">{{ comic?.fileName }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Added</span>
                        <span class="info-value">{{ comic?.addedDate |
                            date:'MMM d, y' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Read</span>
                        <span class="info-value">{{ comic?.lastRead ?
                            (comic?.lastRead | date:'MMM d, y') : 'Never'
                            }}</span>
                    </div>
                    @if (comic?.readTime) {
                    <div class="info-item">
                        <span class="info-label">Read Time</span>
                        <span class="info-value">{{ comic?.readTime }}
                            min</span>
                    </div>
                    }
                </div>
            </div>

            <!-- Comic Summary -->
            @if (comic?.metadata?.summary) {
            <div class="section-card">
                <h3 class="card-title">Summary</h3>
                <div class="summary-content">
                    <p class="summary-text">{{ comic?.metadata?.summary }}</p>
                </div>
            </div>
            }

            <!-- Metadata Editor -->
            <div class="section-card">
                <div class="card-header">
                    <h3 class="card-title">Metadata</h3>
                    <button class="action-btn small" (click)="saveMetadata()"
                        [disabled]="!comic">
                        <svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor">
                            <path
                                d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                                stroke-width="2"></path>
                            <polyline points="17 21 17 13 7 13 7 21"
                                stroke-width="2"></polyline>
                            <polyline points="7 3 7 8 15 8"
                                stroke-width="2"></polyline>
                        </svg>
                        <span>Save</span>
                    </button>
                </div>

                <form class="metadata-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Series</label>
                            <input type="text"
                                [(ngModel)]="editableMetadata.series"
                                name="series"
                                placeholder="e.g., The Amazing...">
                        </div>

                        <div class="form-group">
                            <label>Issue #</label>
                            @if (issueNumberParsed != null) {
                            <input type="number"
                                [(ngModel)]="issueNumberParsed"
                                (ngModelChange)="updateIssueNumberFromParsed()"
                                placeholder="Numeric issue" name="issueNumber">
                            }@else {
                            <input type="text"
                                [(ngModel)]="editableMetadata.issueNumber"
                                name="issueNumber" placeholder="e.g., #1">
                            }
                        </div>

                        <div class="form-group">
                            <label>Volume</label>
                            <input type="text"
                                [(ngModel)]="editableMetadata.volume"
                                name="volume"
                                placeholder="e.g., Volume 1">
                        </div>

                        <div class="form-group">
                            <label>Publisher</label>
                            <input type="text"
                                [(ngModel)]="editableMetadata.publisher"
                                name="publisher" placeholder="e.g., Marvel">
                        </div>

                        <div class="form-group">
                            <label>Year</label>
                            <input type="number"
                                [(ngModel)]="editableMetadata.year" name="year"
                                placeholder="2024" min="1900" max="2100">
                        </div>

                        <div class="form-group">
                            <label>Month</label>
                            <select [(ngModel)]="editableMetadata.month"
                                name="month">
                                <option value>Select month</option>
                                @for (month of months; track month.value) {
                                <option [value]="month.value">{{ month.name
                                    }}</option>
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Writer</label>
                            <input type="text"
                                [(ngModel)]="editableMetadata.writer"
                                name="writer"
                                placeholder="Writer name">
                        </div>

                        <div class="form-group">
                            <label>Artist</label>
                            <input type="text"
                                [(ngModel)]="editableMetadata.penciller"
                                name="artist"
                                placeholder="Artist name">
                        </div>

                        <div class="form-group full-width">
                            <label>Genres</label>
                            <div class="tags-input">
                                @if (editableMetadata.genres &&
                                editableMetadata.genres.length > 0) {
                                @for (tag of editableMetadata.genres; track tag;
                                let i = $index) {
                                <span class="tag">
                                    {{ tag }}
                                    <button type="button" class="tag-remove"
                                        (click)="removeGenre(i)">
                                        ×
                                    </button>
                                </span>
                                }
                                }
                                <input type="text"
                                    #genreInput
                                    placeholder="Add genre (press Enter)"
                                    (keydown.enter)="addGenre($event, genreInput)">
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label>Summary</label>
                            <textarea [(ngModel)]="editableMetadata.summary"
                                name="summary" rows="3"
                                placeholder="Comic summary..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Rating</label>
                            <div class="rating">
                                @for (star of [1,2,3,4,5]; track star) {
                                <button type="button" class="star-btn"
                                    [class.active]="(editableMetadata.rating || 0) >= star"
                                    (click)="setRating(star)">★
                                </button>
                                }
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Reading Progress -->
            <div class="section-card">
                <div class="card-header">
                    <h3 class="card-title">Reading Progress</h3>
                    <button class="action-btn small danger"
                        (click)="resetProgress()"
                        [disabled]="!comic || comic.currentPage === 0">
                        <svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor">
                            <path d="M23 4v6h-6M1 20v-6h6" stroke-width="2"
                                stroke-linecap="round"></path>
                            <path
                                d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"
                                stroke-width="2" stroke-linecap="round"></path>
                        </svg>
                        Reset
                    </button>
                </div>

                <div class="progress-details">
                    <div class="progress-large">
                        <div class="progress-bar-large">
                            <div class="progress-fill"
                                [style.width.%]="progressPercent"></div>
                        </div>
                        <div class="progress-stats">
                            <span class="progress-pages">{{ comic?.currentPage
                                || 0 }} / {{ comic?.totalPages || 0 }}</span>
                            <span class="progress-pct">{{ progressPercent |
                                number:'1.0-0' }}%</span>
                        </div>
                    </div>

                    <div class="page-jump">
                        <label>Jump to page:</label>
                        <div class="page-jump-controls">
                            <input type="number" #pageInput [min]="1"
                                [max]="comic?.totalPages || 0"
                                placeholder="Page #">
                            <button class="action-btn small"
                                (click)="jumpToPage(pageInput.value)"
                                [disabled]="!comic">Go</button>
                        </div>
                    </div>
                </div>

                @if (comic && comic.bookmarks && comic.bookmarks.length > 0) {
                <div class="bookmarks-list">
                    <h4 class="bookmarks-title">Bookmarks ({{
                        comic.bookmarks.length }})</h4>
                    <div class="bookmarks">
                        @for (bookmark of comic.bookmarks; track
                        bookmark.pageNumber) {
                        <div class="bookmark-item">
                            <div class="bookmark-info">
                                <span class="bookmark-page">Page {{
                                    bookmark.pageNumber }}</span>
                                <span class="bookmark-date">{{
                                    bookmark.createdAt | date:'short' }}</span>
                            </div>
                            <div class="bookmark-actions">
                                <button class="icon-btn"
                                    (click)="jumpToPage(bookmark.pageNumber)"
                                    title="Jump to page">
                                    <svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor">
                                        <path d="M5 12h14M12 5l7 7-7 7"
                                            stroke-width="2"></path>
                                    </svg>
                                </button>
                                <button class="icon-btn danger"
                                    (click)="removeBookmark(bookmark.pageNumber)"
                                    title="Remove">
                                    <svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor">
                                        <path d="M6 18L18 6M6 6l12 12"
                                            stroke-width="2"
                                            stroke-linecap="round"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
</div>
