<div class="home-container">
  <!-- App Header -->
  <header class="app-header glass-effect">
    <div class="header-left">
      <div class="logo">
        <img class="logo-icon" src="assets/img/icon-trsp.png" alt="DIComics">
        <span class="logo-text">DIComics</span>
      </div>
    </div>

    <div class="header-center">
      <div class="search-bar">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
        <input type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="applyFilters()"
          placeholder="Search comics..."
          class="search-input">
      </div>
    </div>

    <div class="header-right">
      <button class="upload-btn primary" (click)="uploadFiles()"
        [disabled]="loading">
        @if (loading) {
        <svg class="spinner" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor"
            stroke-width="4" />
        </svg>
        <span>Loading...</span>
        } @else {
        <svg class="upload-icon" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
          <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
          <path d="M12 3V15" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span>Add Comics</span>
        }
      </button>

      <!-- Refresh button -->
      <button class="refresh-btn"
        (click)="refreshLibrary()"
        title="Refresh Library"
        [disabled]="loading">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M23 4v6h-6M1 20v-6h6" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
          <path
            d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>

      <!-- Index button -->
      <button class="index-btn"
        (click)="triggerIndexing()"
        title="Index Library"
        [disabled]="indexing || loading">
        @if (indexing) {
        <div class="spinner-small"></div>
        } @else {
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path
            d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
            stroke-width="2" />
        </svg>
        }
      </button>

      <!-- Settings button -->
      <button class="settings-btn" (click)="router.navigate(['/settings'])"
        title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </button>
      <!-- Settings button -->
      <button class="settings-btn" (click)="router.navigate(['/settings'])"
        title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <polyline points="8 3 3 3 3 8"></polyline>
          <polyline points="16 3 21 3 21 8"></polyline>
          <polyline points="8 21 3 21 3 16"></polyline>
          <polyline points="16 21 21 21 21 16"></polyline>
          <path
            d="M8.5 10a3.5 3.5 0 0 0-5 2.5V17a3 3 0 0 1 3-3h7v-4h-1a3.5 3.5 0 0 0-3.5-3.5V10z"></path>
          <path
            d="M15.5 10a3.5 3.5 0 0 1 5 2.5V17a3 3 0 0 0-3-3h-7v-4h1a3.5 3.5 0 0 1 3.5-3.5V10z"></path>
        </svg>
      </button>

      <div class="user-menu">
        <button class="user-btn" (click)="openOnChangeAboutDialog()"
          title="About & Settings">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
        </button>

      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Filters & Controls -->
    <div class="controls-bar">
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Sort by:</label>
          <div class="filter-buttons">
            <button class="filter-btn"
              [class.active]="sortBy === 'date'"
              (click)="sortBy = 'date'; applyFilters()">
              Recently Added
            </button>
            <button class="filter-btn"
              [class.active]="sortBy === 'name'"
              (click)="sortBy = 'name'; applyFilters()">
              Name (A-Z)
            </button>
            <button class="filter-btn"
              [class.active]="sortBy === 'progress'"
              (click)="sortBy = 'progress'; applyFilters()">
              Progress
            </button>
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Filter by:</label>
          <div class="filter-buttons">
            <button class="filter-btn"
              [class.active]="filterBy === 'all'"
              (click)="filterBy = 'all'; applyFilters()">
              All Comics
            </button>
            <button class="filter-btn"
              [class.active]="filterBy === 'reading'"
              (click)="filterBy = 'reading'; applyFilters()">
              Currently Reading
            </button>
            <button class="filter-btn"
              [class.active]="filterBy === 'unread'"
              (click)="filterBy = 'unread'; applyFilters()">
              Not Started
            </button>
            <button class="filter-btn"
              [class.active]="filterBy === 'completed'"
              (click)="filterBy = 'completed'; applyFilters()">
              Completed
            </button>
          </div>
        </div>
      </div>

      <div class="stats">
        <span class="stat-item">
          <strong>{{ filteredComics.length }}</strong> comics
        </span>
        @if (searchQuery) {
        <span class="stat-item">
          <strong>{{ filteredComics.length }}</strong> results for
          "{{ searchQuery }}"
        </span>
        }
      </div>
    </div>

    <!-- Comics Grid -->
    @if (filteredComics.length > 0) {
    <div class="comics-grid">
      @for (comic of filteredComics; track comic.id) {
      <div class="comic-card scale-in" (click)="openComic(comic)"
        (contextmenu)="openContextMenu($event, comic)">
        <!-- Cover Image or Placeholder -->
        <div class="comic-cover">
          @if (hasCover(comic)) {
          <!-- Real Cover Image -->
          <div class="cover-image-real" [style]="getCoverStyle(comic)">
            <!-- Loading overlay if extracting -->
            @if (coversLoading.has(comic.id)) {
            <div class="cover-loading">
              <div class="loading-spinner-small"></div>
            </div>
            }
          </div>
          } @else {
          <!-- Cover Placeholder -->
          @let placeholder = getCoverPlaceholder(comic);
          @if (placeholder) {
          <div class="cover-placeholder" [class]="placeholder.color">
            <span class="cover-initials">{{ placeholder.initials }}</span>
            <!-- Retry button for failed covers -->
            <button class="cover-retry"
              (click)="retryCoverExtraction(comic, $event)"
              title="Retry cover extraction">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M23 4v6h-6M1 20v-6h6" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round" />
                <path
                  d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"
                  stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>
          </div>
          }
          }

          <!-- Progress Indicator -->
          <div class="cover-progress">
            <div class="progress-ring">
              <svg width="40" height="40">
                <circle cx="20" cy="20" r="18" stroke="var(--bg-surface)"
                  stroke-width="3" fill="none" />
                <circle cx="20" cy="20" r="18" stroke="var(--accent)"
                  stroke-width="3" fill="none"
                  [attr.stroke-dasharray]="113"
                  [attr.stroke-dashoffset]="113 - (getProgressPercent(comic) / 100 * 113)"
                  transform="rotate(-90 20 20)" />
              </svg>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="cover-actions">
            <button class="cover-action-btn" (click)="markAsRead(comic, $event)"
              title="Mark as read">
              @if (comic.isRead) {
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
              </svg>
              } @else {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M20 6L9 17L4 12" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              }
            </button>
            <button class="cover-action-btn delete"
              (click)="deleteComic(comic, $event)" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20"
                  stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>
            <!-- Add context menu trigger button -->
            <button class="cover-action-btn"
              (click)="openContextMenu($event, comic)"
              title="More options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="6" r="1" stroke-width="2" />
                <circle cx="12" cy="12" r="1" stroke-width="2" />
                <circle cx="12" cy="18" r="1" stroke-width="2" />
              </svg>
            </button>
          </div>

          <!-- Cover Status Badge -->
          <div class="cover-status">
            @if (hasCover(comic)) {
            <span class="status-badge success" title="Cover extracted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M5 13l4 4L19 7" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </span>
            } @else {
            <span class="status-badge warning" title="Placeholder cover">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </span>
            }
          </div>
        </div>

        <!-- Comic Info -->
        <div class="comic-info">
          <h3 class="comic-title">{{ comic.title }}</h3>

          <div class="comic-meta">
            <span class="meta-item">
              <svg class="meta-icon" viewBox="0 0 24 24" fill="none"
                stroke="currentColor">
                <path
                  d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                  stroke-width="2" stroke-linecap="round" />
              </svg>
              {{ comic.addedDate | date:'MMM d, y' }}
            </span>
            <span class="meta-item">
              <svg class="meta-icon" viewBox="0 0 24 24" fill="none"
                stroke="currentColor">
                <path
                  d="M3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19Z"
                  stroke-width="2" />
                <path d="M3 9H21M9 21V9" stroke-width="2" />
              </svg>
              {{ comic.fileSize | fileSize }}
            </span>
            @if (comic.totalPages > 0) {
            <span class="meta-item">
              <svg class="meta-icon" viewBox="0 0 24 24" fill="none"
                stroke="currentColor">
                <path
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                  stroke-width="2" />
              </svg>
              {{ comic.totalPages }} pages
            </span>
            }
          </div>

          <!-- Progress Bar -->
          @if (comic.totalPages > 0) {
          <div class="comic-progress">
            <div class="progress-bar">
              <div class="progress-fill"
                [style.width.%]="getProgressPercent(comic)"></div>
            </div>
            <div class="progress-text">
              {{ getProgress(comic) }} / {{ comic.totalPages }} pages
              <span class="progress-percent">({{ getProgressPercent(comic) |
                number:'1.0-0' }}%)</span>
            </div>
          </div>
          }

          <!-- Status Badges -->
          <div class="comic-badges">
            @if (comic.isRead) {
            <span class="badge badge-success">Read</span>
            }
            @if (comic.bookmarks.length > 0) {
            <span class="badge badge-primary">{{ comic.bookmarks.length }}
              ðŸ”–</span>
            }
            @if (getProgressPercent(comic) >= 50 && getProgressPercent(comic) <
            100) {
            <span class="badge badge-warning">In Progress</span>
            }
            @if (!hasCover(comic)) {
            <span class="badge badge-secondary">No Cover</span>
            }
          </div>
        </div>
      </div>
      }
    </div>
    } @else {
    <div class="empty-state fade-in">
      <div class="empty-state-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path
            d="M3 18V6C3 4.34315 4.34315 3 6 3H18C19.6569 3 21 4.34315 21 6V18C21 19.6569 19.6569 21 18 21H6C4.34315 21 3 19.6569 3 18Z"
            stroke-width="2" />
          <path d="M8 9H16M8 13H16M8 17H12" stroke-width="2"
            stroke-linecap="round" />
        </svg>
      </div>
      <h2>No Comics Found</h2>
      <p class="empty-state-text">
        @if (searchQuery) {
        No comics match "{{ searchQuery }}". Try a different search or
        <button class="text-link"
          (click)="searchQuery = ''; applyFilters()">clear filters</button>.
        } @else {
        Your library is empty. Start by adding some comics!
        }
      </p>
      <button class="upload-btn large primary" (click)="uploadFiles()"
        [disabled]="loading">
        @if (loading) {
        <svg class="spinner" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor"
            stroke-width="4" />
        </svg>
        <span>Loading...</span>
        } @else {
        <svg class="upload-icon" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
          <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
          <path d="M12 3V15" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span>Add Your First Comic</span>
        }
      </button>
    </div>
    }
  </main>
<!-- About dialog -->
  @if (aboutDialogOpen) {
    <app-about (aboutDialogOpenChange)="openOnChangeAboutDialog($event)" ></app-about>
  }
  <!-- Add indexing progress overlay -->
  @if (indexing) {
  <div class="indexing-overlay">
    <div class="indexing-modal">
      <h3>Indexing Library</h3>
      <div class="indexing-progress">
        <div class="progress-header">
          <span class="source-name">{{ indexingProgress.currentSource }}</span>
          <span class="progress-percent">{{ indexingProgress.percent }}%</span>
        </div>
        <div class="progress-text">
          {{ indexingProgress.processed }} of {{ indexingProgress.total }} files
        </div>
        <div class="progress-bar">
          <div class="progress-fill"
            [style.width.%]="indexingProgress.percent"></div>
        </div>
        <div class="current-file">
          {{ indexingProgress.currentFile }}
        </div>
      </div>
      <button class="cancel-btn" (click)="cancelIndexing()"
        [disabled]="!indexing">
        Cancel
      </button>
    </div>
  </div>
  }

  <!-- Add toast notification -->
  @if (showToast) {
  <div class="toast-notification" [class]="toastType">
    <div class="toast-content">
      <span class="toast-message">{{ toastMessage }}</span>
      <button class="toast-close" (click)="showToast = false">Ã—</button>
    </div>
  </div>
  }

  <!-- Add this near the end of the template, before closing div -->
  @if (contextMenu.comic) {
  <div class="context-menu-overlay" (click)="closeContextMenu()"></div>
  <div class="context-menu"
    [style.left.px]="contextMenu.x"
    [style.top.px]="contextMenu.y">
    <div class="context-menu-header">
      <h4>{{ contextMenu.comic.title }}</h4>
    </div>
    <div class="context-menu-items">
      <button class="context-menu-item"
        (click)="openComicDetails(contextMenu.comic)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            stroke-width="2" />
        </svg>
        <span>Comic Details</span>
      </button>

      <button class="context-menu-item" (click)="openComic(contextMenu.comic)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M5 12h14M12 5l7 7-7 7" stroke-width="2"
            stroke-linecap="round" />
        </svg>
        <span>Read Now</span>
      </button>

      <button class="context-menu-item"
        (click)="quickEditMetadata(contextMenu.comic)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path
            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
            stroke-width="2" />
        </svg>
        <span>Edit Metadata</span>
      </button>

      <button class="context-menu-item"
        (click)="setReadingMode(contextMenu.comic)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
            stroke-width="2" />
        </svg>
        <span>Reading Mode</span>
      </button>

      <div class="context-menu-divider"></div>

      <button class="context-menu-item"
        (click)="markAsRead(contextMenu.comic, $event)">
        @if (contextMenu.comic.isRead) {
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
        </svg>
        <span>Mark as Unread</span>
        } @else {
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20 6L9 17L4 12" stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>Mark as Read</span>
        }
      </button>

      <button class="context-menu-item"
        (click)="openComicFolder(contextMenu.comic, $event)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
            stroke-width="2" />
        </svg>
        <span>Open Folder</span>
      </button>

      <div class="context-menu-divider"></div>

      <button class="context-menu-item delete"
        (click)="deleteComic(contextMenu.comic, $event)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path
            d="M19 7l-.867 12.142C18.058 20.189 17.187 21 16.138 21H7.862c-1.05 0-1.92-.811-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4c0-.552-.448-1-1-1h-4c-.552 0-1 .448-1 1v3M4 7h16"
            stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>Delete Comic</span>
      </button>
    </div>
  </div>
  }
</div>